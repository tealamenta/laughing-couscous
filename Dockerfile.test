FROM python:3.12-slim

WORKDIR /app

# Install poetry
RUN pip install --no-cache-dir poetry==1.7.1

# Copy dependency files
COPY pyproject.toml poetry.lock ./

# Install ALL dependencies (including dev)
RUN poetry config virtualenvs.in-project true && \
    poetry install --no-interaction --no-ansi

# Copy code
COPY src/ ./src/
COPY tests/ ./tests/
COPY data/ ./data/

# Install package in editable mode
RUN poetry run pip install -e .

ENV PATH="/app/.venv/bin:$PATH" \
    PYTHONUNBUFFERED=1 \
    PYTHONPATH=/app/src

# Run tests
CMD ["pytest", "tests/", "-v", \
     "--cov=src/recipe_recommender", \
     "--cov-report=term", \
     "--cov-report=html"]
